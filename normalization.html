---
layout: base
title:  "Normalization"
---

<h1>brat normalization</h1>

<p><strong>Note:</strong> normalization features are new
  in <strong>version 1.3 (Crunchy Frog)</strong>. Please make sure
  you're running version 1.3 or newer before attempting to set up
  normalization.
<p>

<h2 id="introduction">Introduction</h2>

<div class="image">
  <img src="img/normalization-example-1.png" alt="Information popup for normalized annotation"/>
  <div style="width: 800px" class="caption">Popup showing additional information from Wikipedia for a normalized annotation.</div>
</div>

<p>The identification of the real-world entities that are referred to
  in text is an important part of analysing the meaning of text.  Many
  specific task formulations that involve the association of text with
  entries in external resources such as ontologies and entity
  databases are studied, with tasks termed variously as 
  <i>normalization</i>, <i>grounding</i>,
  <i>entity linking</i> and <i>wikification</i>.
</p>

<p>As of version 1.3, brat implements a number of features for supporting
  the visualization and manual creation of such annotations:
</p>

<ul>
  <li><i>Normalization</i> annotation primitive associating brat
    annotations with entries in external resources
  </li>
  <li>Visualization functionality showing information from ontological
    and database resources
  </li>
  <li>Tools for creating, accessing and managing normalization databases
  </li>
  <li>Comprehensive annotation support for normalization, including
    fast approximate string search for large databases
  </li>
</ul>

<p>This page briefly introduces these features and how to set brat
  up for the visualization and creation of normalization annotations.
</p>

<h2 id="requirements">Requirements</h2>

<p>The brat normalization system uses 
  <a href="www.chokkan.org/software/simstring/">SimString</a> for
  approximate string matching. Before trying to set up brat for
  normalization, please install SimString and its python bindings
  following the instructions on the SimString homepage.
</p>

<h2 id="quickstart">Quick start</h2>

<p>If you want to set up normalization in brat using your own data,
  skip over this section into <a href="#setup">setup</a>. To quickly
  test the brat normalization functionality on some example data, just
  follow these easy steps:
</p>

<p>In the brat root directory, run the following command:
</p>

<p><pre><code>    python tools/norm_db_init.py example-data/normalisation/Wiki.txt</code></pre>
</p>

<p>This will create a normalization DB using a small sample of data
  from the <a href="http://en.wikipedia.org">English Wikipedia</a>.
</p>

<p>Next, open the <code>tools.conf</code> file using your favorite
  text editor and add the following line to the
  <code>[normalization]</code> section (as one line):
</p>

<p><pre><code>    Wiki    &lt;URL&gt;:http://en.wikipedia.org, &lt;URLBASE&gt;:http://en.wikipedia.org/?curid=%s</code></pre>
</p>

<p>This tells brat that a DB with the name "Wiki" is set up for
  normalization and provides links to the homepage and online term
  lookup that will be shown in the brat UI.
</p>

<p>That's all! Now, when creating annotations, you will be able to
  search (a sample of) Wikipedia from within brat and attach
  normalization annotations to other annotations, as shown in the next
  section.
</p>

<h2 id="norm-annotation">Normalization annotation</h2>

<p>After setting up a normalization database and editing
  <code>tools.conf</code> to configure brat to use it, brat is ready
  to create normalization annotations. Note that you should reload any
  open brat windows for the configuration change to take effect.
</p>

<p>When creating any annotation marking a text span such as an entity
  annotation, the "Edit annotation" dialog should now include an
  additional section for normalization:
</p>
<div class="image">
  <img src="img/span-dialog-with-normalization-1.png" alt="edit annotation dialog with normalization"/>
  <div style="width: 800px" class="caption">"Edit annotation" dialog configured for normalization.</div>
</div>

<p>To create a normalization annotation, it's often necessary to
  search for the unique identifier (ID) of the intended entry, as IDs
  are typically just meaningless sequences of numbers. The brat UI
  provides access to two alternative searches:
</p>
<ul>
  <li>clicking on the box with "Click here to search" opens the built-in
    normalization DB search functionality within brat (shown below)
  </li>
  <li>clicking on the magnifying glass logo opens a separate page with
    the resource URL (as <a href="#norm-config">configured
    in <code>tools.conf</code></a> by the &lt;URL&gt; setting),
    providing fast access to "native" search functionality that can
    be used to determine the ID, which can then be copied into the brat
    dialog.
  </li>
</ul>
<div class="image">
  <img src="img/normalization-search-example.png" alt="normalization search dialog"/>
  <div style="width: 800px" class="caption">Normalization search dialog showing search results from Wikipedia.</div>
</div>

<p>The search dialog can be used to query the brat normalization DB
  using approximate string matching, which allows for variation and
  typos (e.g. "Barak Obama"). The correct entry can be selected and
  its ID associated with the annotation simply by double-clicking on
  it.
</p>

<p>After filling in the ID, the brat annotation dialog is updated to
  show also a direct link to the entry in the resource
  (as <a href="#norm-config">configured in <code>tools.conf</code></a>
  by the &lt;URLBASE&gt; setting).
  <!-- TODO image -->
</p>

<p>If you're going to be working on normalization annotation on a brat
  server administered by someone else, that's all you need to know!
  If you need to set up a normalization database and configure brat
  for normalization yourself, read on.
</p>

<h2 id="setup">Database setup</h2>

<p>Before brat can be used for normalization to a specific resource, it
  is necessary to create a brat normalization DB for that resource. This
  can be easily done using tools distributed with brat.
</p>

<p>Given a file with the normalization data in the
  <a href="#norm-file-format">text-based brat normalization data
  format</a> (examples are found in 
  <code>example-data/normalisation/</code>), a new normalization DB
  can be set up simply by running the following command in the brat
  root directory:
</p>

<p><pre><code>    python tools/norm_db_init.py FILE</code></pre>
</p>

<p>where <code>FILE</code> is the name of the file containing the
  normalization data. This will create a brat normalization DB, by
  default with the same name as FILE (without filename suffix),
  storing the DB in the brat <code>work/</code> directory.
</p>

<p>To see the options for this tool, run
</p>

<p><pre><code>    python tools/norm_db_init.py -h</code></pre>
</p>

<p>For information on testing a normalization DB using command-line
  tools, see <a href="#norm-db-tools">normalization DB tools</a>.
</p>

<p>After creating a normalization DB, it's necessary to edit the
  <code>tools.conf</code> file to configure normalization.
</p>

<h2 id="norm-config">Configuration</h2>

<p>Normalization configuration is part of the <code>tools.conf</code>
  file, where the relevant settings are contained in the
  <code>[normalization]</code> section. The full syntax of each line
  in this section is as follows:
</p>

<!-- TODO: support alternative locations for norm DB in conf (DBPATH) -->
<!-- <p><pre><code>    DBNAME    &lt;URL&gt;:HOMEURL, &lt;URLBASE&gt;:ENTRYURL, &lt;PATH&gt;:DBPATH</code></pre> -->
<!-- </p> -->
<p><pre><code>    DBNAME    &lt;URL&gt;:HOMEURL, &lt;URLBASE&gt;:ENTRYURL</code></pre>
</p>

<p>Here, "<code>&lt;URL&gt;</code>", "<code>&lt;URLBASE&gt;</code>"
  and "<code>&lt;PATH&gt;</code>" are literal strings (they should appear
  as written here), while <code>DBNAME</code>, <code>HOMEURL</code> and
  <code>ENTRYURL</code> 
<!--   and <code>DBPATH</code>  -->
  should be replaced
  with specific values appropriate for the database being configured:
</p>

<ul>
  <li><code>DBNAME</code>: sets the database name (e.g. "Wiki",
    "GO"). The name can be otherwise freely selected, but should not
    contain characters other than alphanumeric
    (&quot;a&quot;-&quot;z&quot;, &quot;A&quot;-&quot;Z&quot;,
    &quot;0&quot;-&quot;9&quot;), hyphen (&quot;-&quot;) and underscore
    (&quot;_&quot;). This name will be used both in the brat UI and in
    the <a href="#norm-standoff">annotation file</a> to identify the DB.
  </li>
  <li><code>HOMEURL</code>: sets the URL for the home page of the
    normalization resource (e.g. "http://en.wikipedia.org/wiki/").
    Used both to identify the resource more specifically
    than <code>DBNAME</code> and to provide a link in the
    <a href="#norm-annotation">annotation UI</a> for accessing the
    resource.
  </li>
  <li><code>URLBASE</code> (optional): sets a URL template
    (e.g. "http://en.wikipedia.org/?curid=%s") that can be filled in
    to generate a direct link in
    the <a href="#norm-annotation">annotation UI</a> to an entry in
    the normalization resource. The value should contain the
    characters "%s" as a placeholder that will be replaced with the ID
    of the entry.
  </li>
<!-- TODO: support alternative locations for norm DB in conf (DBPATH) -->
<!--   <li><code>DBPATH</code> (optional): provides the file system path to -->
<!--     the normalization DB data on the server. If <code>DBPATH</code> -->
<!--     isn't set, the system assumes the DB can be found in the default -->
<!--     location under the given <code>DBNAME</code>. -->
<!--   </li> -->
</ul>

<p>Note that it's individual collections can have their
  own <code>tools.conf</code> files, so different annotation projects
  can have different normalization settings.
</p>

<p>After creating a normalization DB and configuring brat to use it,
  brat is ready for <a href="#norm-annotation">normalization
  annotation</a>. For information on how to format any dataset for use
  for brat normalization, see the next section.
</p>

<h2 id="norm-file-format">Normalization DB file format</h2>

<p>To make it easier to set up brat for normalization annotation using
  new resources, brat defines a simple text-based file format that
  can be used to import data into the brat normalization system.
</p>

<p>Each line in the input file should have the following format:</p>

<p><pre><code>    ID &lt;TAB&gt; TYPE1:LABEL1:STRING1 &lt;TAB&gt; TYPE2:LABEL2:STRING2 [...]</code></pre>
</p>

<p>Where the ID is the unique ID used in normalization, and the
  <code>TYPE</code>:<code>LABEL</code>:<code>STRING</code> triplets
  provide various information associated with the ID. 
  (<code>&lt;TAB&gt;</code> is the literal tab character "\t".)
</p>

<p>Each <code>TYPE</code> must be one of the following:</p>

<ul>
<li>"name": <code>STRING</code> is name or alias</li>
<li>"attr": <code>STRING</code> is non-name attribute</li>
<li>"info": <code>STRING</code> is non-searchable additional information</li>
</ul>

<p>Each <code>LABEL</code> provides a human-readable label used in the
  <a href="#norm-annotation">normalization UI</a> for the
  <code>STRING</code>. <code>LABEL</code> values are not used for querying.
</p>

<p>For example, for normalization to Wikipedia, the input could
  contain lines such as the following:
</p>

<p><pre><code>    843          name:Title:A Clockwork Orange      attr:Category:book
    1659954      name:Title:A Clockwork Orange      attr:Category:film</code></pre>
</p>

<p>Specifying that "A Clockwork Orance" is the title of a book and a
  film, and allowing normalization annotation to differentiate between
  the two.
</p>

<p>Each entry must have at least one name, but all other information
  is optional. There is no need for any of the fields (or their values)
  to be unique; for example, the following is a valid entry:
</p>

<p><pre><code>    534366       name:Name:Barack Obama      name:Name:Obama      attr:Category:person      attr:Category:US president</code></pre>
</p>

<p>Given a file in this format, a normalization DB can be created as
  described in <a href="#setup">database setup</a>. A number of example
  files in this format are found in 
  <code>example-data/normalisation/</code> directory in the brat
  installation.
</p>

<h2 id="norm-db-tools">Normalization DB tools</h2>

<p>brat provides also some command-line tools for working with
  normalization DBs. These are found along with many other tools in
  the <code>tools/</code> tools directory of the brat installation.
</p>

<p>The script <code>norm_db_lookup.py</code> can be used to retrieve
  the ID and other information stored in a normalization DB for a
  given entry name. This tool can be helpful for troubleshooting
  normalization DB setup. An example session (user input shown in 
  <span style="color:blue">blue</span>)
</p>

<p><pre><code>python tools/norm_db_lookup.py Wikipedia
>>> <span style="color:blue">Google</span>
 1092923	Name:Google		Info:Google Inc. is an American multinational Internet and software corporation [...]
>>> <span style="color:blue">Barak Obama</span>
 (no record found for 'Barak Obama')
>>> <span style="color:blue">Barack Obama</span>
 534366	Name:Barack Obama		Info: Barack Hussein Obama II is the 44th and current President of the United States.
>>> <span style="color:blue">[CRTL-D]</span></code></pre>
</p>

<p>(Note that this tool does not perform approximate string matching.)</p>

<!-- TODO: deleting norm DBs -->

<h2 id="norm-standoff">Standoff format for normalization</h2>

<p>The brat normalization support involves a new category of annotation
  in the <a href="standoff.html">standoff format</a> used to store brat
  annotations. (If you don't work directly with the brat standoff format,
  you can skip these technical details.)
</p>

<p>First, brat 1.3 is fully backward compatible with previous
  versions, and any standoff file created in previous versions of brat
  is also valid for 1.3. The text file format and the standoff format
  for annotation primitives defined in previous versions of brat
  (text-bound annotations, relations, etc.) are also unchanged in
  version 1.3. To understand the basic brat standoff format, see the
  <a href="standoff.html">standoff format description</a>.
</p>

<p>To support normalization, version 1.3 introduces a new category of
  annotation, <i>normalization</i>. Each normalization annotation has
  a unique ID and is defined by reference to the ID of the annotation
  that the normalization attaches to and a <code>RID:EID</code> pair
  identifying the external resource (<code>RID</code>) and the entry
  within that resource (<code>EID</code>). Additionally, each
  normalization annotation has the type <code>Reference</code> (no
  other values for the type are currently defined) and a
  human-readable string value for the entry referred to.
</p>

<p>The following example shows a normalization annotation attached to
  the text-bound annotation "T1" (not shown) and associates it with
  the Wikipedia entry with the Wikipedia ID "534366" ("Barack Obama").
</p>

<table class="annotation_wrapper"><tr><td>
      <table class="annotation_table">
	<tr>
	  <td width="100">N1</td><td width="250">Reference T1 Wikipedia:534366</td><td>Barack Obama</td>
	</tr>
      </table>
</td></tr></table>

<p>As for text-bound annotations, the ID and the text are separated by
  TAB characters, and other fields (here, "Reference", "T1" and
  "Wikipedia:534366") by SPACE.
</p>

<p>The IDs of normalization annotations follow the general ID
  conventions in brat and consist of the upper-case character "N" an a
  number.
</p>

<h2 id="norm-trouble">Troubleshooting</h2>

<h3>Normalization configuration fails to take effect</h3>

<p>It is necessary to reload the collection for changes to
  configuration to take effect. This can be done either by navigating
  to a different collection and back, or simply by reloading the brat
  page in the browser.
</p>

<p>If the issue persists after reloading the collection, it may be
  that brat is reading a different <code>tools.conf</code> file than
  the one that was edited to configure normalization. For example, if
  the collection contains a <code>tools.conf</code>, that
  configuration will be used in favor of ones in containing
  collections and the brat root directory.
</p>

<h3>Search fails to return expected results</h3>

<p>If brat is showing a specific error message when a search is
  performed, this message should indicate what the specific issue is.
</p>

<p>If search fails to return expected results without giving any
  specific error message, first make sure that the data that was used
  to create the DB is <a href="#norm-file-format">correctly
  formatted</a>. Note that search requires a match against a 
  <code>name</code> field in the data; it's not enough for the query
  string to match e.g. just part of an <code>info</code> field.

<p>The <a href="#norm-db-tools">norm_db_lookup.py</a> tool
  provided with brat can be used to check DB contents from the command
  line.
</p>
